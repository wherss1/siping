<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>【终极版】全能播放器</title>
    <!-- 引入 Plyr 播放器样式 -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <style>
        /* 确保播放器铺满整个页面 */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
        }
        .container {
            width: 100%;
            height: 100%;
        }
        /* 【关键修复】强制让Plyr的控制栏和进度条永远可见，不再自动隐藏 */
        .plyr--video .plyr__controls {
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: all !important;
        }
        .plyr--video .plyr__progress__container {
            opacity: 1 !important;
            visibility: visible !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 视频播放器本体 -->
        <video id="player" playsinline controls></video>
    </div>

    <!-- 引入 HLS.js 库 (用于解码 m3u8) -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <!-- 引入 Plyr 播放器库 -->
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const video = document.getElementById('player');
            let player;

            // 1. 从URL获取m3u8视频地址
            const urlParams = new URLSearchParams(window.location.search);
            const m3u8Url = urlParams.get('m3u8');

            if (!m3u8Url) {
                console.error("错误：URL中未提供m3u8地址。");
                return;
            }

            // 2. 判断浏览器支持情况，优先使用HLS.js
            if (Hls.isSupported()) {
                console.log("HLS.js 已支持，开始加载...");
                const hls = new Hls({
                    // 健壮的配置，增强稳定性和容错性
                    maxBufferLength: 30,
                    maxMaxBufferLength: 600,
                    startLevel: -1, // 自动选择最佳码率
                    // 开启worker，提升性能
                    enableWorker: true,
                    // 遇到网络错误时，自动重试
                    manifestLoadingMaxRetry: 3,
                    levelLoadingMaxRetry: 4,
                });

                hls.loadSource(m3u8Url);
                hls.attachMedia(video);

                // 监听关键事件：当视频信息解析成功后，再初始化Plyr播放器
                hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
                    console.log('HLS清单解析成功，视频信息已加载。');
                    initializePlyr();
                });

                // 监听错误事件，并尝试恢复
                hls.on(Hls.Events.ERROR, function (event, data) {
                    if (data.fatal) {
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                console.error('网络错误，尝试恢复...', data);
                                hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                console.error('媒体错误，尝试恢复...', data);
                                hls.recoverMediaError();
                                break;
                            default:
                                console.error('无法恢复的致命错误，销毁HLS实例。', data);
                                hls.destroy();
                                break;
                        }
                    }
                });

            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // 备用方案：针对Safari等原生支持HLS的浏览器
                console.log("浏览器原生支持HLS。");
                video.src = m3u8Url;
                video.addEventListener('loadedmetadata', () => {
                     console.log('视频元数据已加载（原生）。');
                     initializePlyr();
                });
            } else {
                 console.error("错误：此浏览器不支持HLS播放。");
                 return;
            }

            // 3. 初始化Plyr播放器UI的函数
            function initializePlyr() {
                // 如果播放器已存在，则不再重复初始化
                if (player) return;

                player = new Plyr(video, {
                    title: '全能播放器',
                    // 【关键】定义需要显示的全部控制按钮
                    controls: [
                        'play-large', // 大播放按钮
                        'restart',    // 重新播放
                        'rewind',     // 快退
                        'play',       // 播放/暂停
                        'fast-forward', // 快进
                        'progress',   // 进度条
                        'current-time', // 当前时间
                        'duration',   // 总时长
                        'mute',       // 静音
                        'volume',     // 音量
                        'captions',   // 字幕
                        'settings',   // 设置（速度、画质）
                        'pip',        // 画中画
                        'airplay',    // AirPlay
                        'fullscreen'  // 全屏
                    ],
                    // 禁用Plyr自己的自动隐藏逻辑，我们用CSS强制显示
                    hideControls: false,
                    // 启用快捷键
                    keyboard: { focused: true, global: true },
                    // 启用工具提示
                    tooltips: { controls: true, seek: true }
                });

                // 确保视频加载后自动播放
                player.on('ready', () => {
                    console.log('Plyr播放器已准备就绪。');
                    player.play();
                });
            }
        });
    </script>
</body>
</html>
