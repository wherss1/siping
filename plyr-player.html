<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>【终极修复版】全能播放器</title>
    <link rel="stylesheet" href="https://cdn.bytedance.com/plyr/3.7.8/plyr.css" />
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; }
        .container, #player { width: 100%; height: 100%; }
        .plyr--video .plyr__controls, .plyr--video .plyr__progress__container { opacity: 1 !important; visibility: visible !important; pointer-events: all !important; }
    </style>
</head>
<body>
    <div class="container">
        <video id="player" playsinline controls></video>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/hls.js/1.5.8/hls.min.js"></script>
    <script src="https://cdn.bytedance.com/plyr/3.7.8/plyr.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const video = document.getElementById('player');
            let player;

            const urlParams = new URLSearchParams(window.location.search);
            const originalM3u8Url = urlParams.get('m3u8');

            if (!originalM3u8Url) {
                console.error("播放助手错误：URL中未提供m3u8地址。");
                return;
            }

            // 【终极修复】使用CORS安全中转站来加载视频流
            // 这是一个免费、公开的代理服务，专门用于解决跨域问题
            const corsProxy = "https://cors.eu.org/";
            const proxiedM3u8Url = corsProxy + originalM3u8Url;
            
            console.log("播放助手提示：原始URL ->", originalM3u8Url);
            console.log("播放助手提示：通过CORS中转站加载 ->", proxiedM3u8Url);

            if (Hls.isSupported()) {
                const hls = new Hls({
                    maxBufferLength: 30, maxMaxBufferLength: 600,
                    startLevel: -1, enableWorker: true,
                    manifestLoadingMaxRetry: 3, levelLoadingMaxRetry: 4,
                });

                hls.loadSource(proxiedM3u8Url); // 使用经过中转的URL
                hls.attachMedia(video);

                hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
                    console.log("播放助手提示：HLS清单解析成功。");
                    initializePlyr();
                });

                hls.on(Hls.Events.ERROR, (event, data) => {
                    console.error('播放助手错误：HLS.js遇到错误。', data);
                    if (data.fatal) {
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                hls.startLoad(); break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                hls.recoverMediaError(); break;
                            default: hls.destroy(); break;
                        }
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = proxiedM3u8Url; // Safari等也需要通过中转
                video.addEventListener('loadedmetadata', () => initializePlyr());
            } else {
                console.error("播放助手错误：此浏览器不支持HLS播放。");
            }

            function initializePlyr() {
                if (player) return;
                player = new Plyr(video, {
                    title: '全能播放器',
                    controls: ['play-large', 'restart', 'rewind', 'play', 'fast-forward', 'progress', 'current-time', 'duration', 'mute', 'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'],
                    settings: ['captions', 'quality', 'speed'],
                    speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 2] },
                    hideControls: false,
                    keyboard: { focused: true, global: true },
                    tooltips: { controls: true, seek: true }
                });

                player.on('ready', () => {
                    player.speed = 1.0;
                    video.playbackRate = 1.0;
                    player.play();
                });
                
                player.on('ratechange', () => {
                    if(video.playbackRate !== player.speed) video.playbackRate = player.speed;
                });
            }
        });
    </script>
</body>
</html>
