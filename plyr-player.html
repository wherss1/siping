<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Enhanced Plyr Player</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }
        .player-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        video {
            width: 100% !important;
            height: 100% !important;
            object-fit: contain;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        /* Plyr样式优化 */
        .plyr {
            width: 100% !important;
            height: 100% !important;
            --plyr-color-main: #ff0000;
        }
        .plyr--video .plyr__controls {
            padding: 20px !important;
            background: linear-gradient(rgba(0,0,0,0), rgba(0,0,0,0.7)) !important;
        }
        .plyr__controls {
            opacity: 1 !important;
            visibility: visible !important;
        }
        .plyr--video .plyr__controls button:hover {
            background: rgba(255,255,255,0.2);
        }
        .plyr--full-ui input[type=range] {
            color: #ff0000 !important;
        }
        .plyr__control--overlaid {
            background: rgba(255,0,0,0.8) !important;
        }
        .plyr__control--overlaid:hover {
            background: #ff0000 !important;
        }
        .plyr--video .plyr__progress__buffer {
            color: rgba(255,255,255,0.3);
        }
        .plyr__progress input[type=range] {
            cursor: pointer;
        }
        .plyr__progress__container {
            margin: 0 10px;
        }
        /* 确保控制栏始终可见 */
        .plyr--video.plyr--hide-controls .plyr__controls {
            opacity: 1 !important;
            pointer-events: auto !important;
            transform: none !important;
        }

        /* 新增：状态提示样式 */
        #player-status {
            position: absolute;
            top: 20px;  /* 改为顶部显示 */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 9999;
            pointer-events: none; /* 确保不影响下方元素的点击 */
            transition: opacity 0.3s;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div class="player-container">
        <video id="player" playsinline controls crossorigin>
            <source type="application/x-mpegURL">
        </video>
        <!-- 新增：状态提示元素 -->
        <div id="player-status" style="display: none;"></div>
    </div>
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const video = document.querySelector('video');
            const playerStatus = document.getElementById('player-status');

            // 状态提示函数
            function showStatus(text, duration = 3000) {
                playerStatus.textContent = text;
                playerStatus.style.display = 'block';
                setTimeout(() => {
                    playerStatus.style.opacity = '0';
                    setTimeout(() => {
                        playerStatus.style.display = 'none';
                        playerStatus.style.opacity = '1';
                    }, 300);
                }, duration);
            }
            
            // Plyr播放器配置
            const player = new Plyr(video, {
                controls: [
                    'play-large',
                    'restart',
                    'rewind',
                    'play',
                    'fast-forward',
                    'progress',
                    'current-time',
                    'duration',
                    'mute',
                    'volume',
                    'settings',
                    'fullscreen'
                ],
                settings: ['quality', 'speed'],
                speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 2] },
                keyboard: { focused: true, global: true },
                tooltips: { controls: true, seek: true },
                seekTime: 10,
                hideControls: false
            });

            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const m3u8Url = urlParams.get('m3u8');

            if (m3u8Url) {
                if (Hls.isSupported()) {
                    const hls = new Hls({
                        maxBufferLength: 30,
                        maxMaxBufferLength: 600,
                        maxBufferSize: 60 * 1000 * 1000,
                        maxBufferHole: 0.5,
                        lowLatencyMode: true,
                        enableWorker: true,
                        debug: false
                    });

                    // 加载视频
                    showStatus('正在加载视频...');
                    hls.loadSource(m3u8Url);
                    hls.attachMedia(video);

                    // HLS事件处理
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        showStatus('视频加载完成，开始播放');
                        player.play().catch(() => {
                            showStatus('自动播放被浏览器阻止，请手动播放');
                        });
                    });

                    // 错误处理和自动恢复
                    hls.on(Hls.Events.ERROR, function(event, data) {
                        if (data.fatal) {
                            switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    showStatus('网络错误，正在尝试恢复...');
                                    hls.startLoad();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    showStatus('媒体错误，正在尝试恢复...');
                                    hls.recoverMediaError();
                                    break;
                                default:
                                    showStatus('播放错误，请刷新重试');
                                    hls.destroy();
                                    break;
                            }
                        }
                    });

                    // 清理函数
                    window.addEventListener('beforeunload', () => {
                        hls.destroy();
                    });

                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = m3u8Url;
                }
            }

            // 播放器事件监听
            player.on('ready', () => {
                showStatus('播放器就绪');
            });

            player.on('play', () => {
                showStatus('开始播放');
            });

            player.on('pause', () => {
                showStatus('暂停播放');
            });

            player.on('ended', () => {
                showStatus('播放结束');
            });

            player.on('error', (error) => {
                showStatus('播放器错误，请刷新重试');
            });

            // 键盘快捷键
            document.addEventListener('keydown', (e) => {
                if (!e.ctrlKey && !e.altKey && !e.shiftKey) {
                    switch(e.key.toLowerCase()) {
                        case ' ':
                            player.togglePlay();
                            e.preventDefault();
                            break;
                        case 'arrowleft':
                            player.rewind();
                            e.preventDefault();
                            break;
                        case 'arrowright':
                            player.forward();
                            e.preventDefault();
                            break;
                        case 'm':
                            player.toggleMute();
                            e.preventDefault();
                            break;
                        case 'f':
                            player.toggleFullscreen();
                            e.preventDefault();
                            break;
                    }
                }
            });

            // 确保控制栏始终可见
            setInterval(() => {
                const controls = document.querySelector('.plyr__controls');
                if (controls) {
                    controls.style.opacity = '1';
                    controls.style.visibility = 'visible';
                    controls.style.transform = 'none';
                }
            }, 1000);
        });
    </script>
</body>
</html>
