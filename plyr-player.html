
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plyr M3U8 Player (v6 - Layout Fix)</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <style>
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #000;
            display: flex; justify-content: center; align-items: center;
        }

        /* 【关键修复】1. 创建一个相对定位的包装器作为舞台 */
        #player-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex; /* 内部元素也居中 */
            justify-content: center;
            align-items: center;
        }
        #player { max-width: 100%; max-height: 100%; }

        /* 【关键修复】2. 升级应急进度条的样式 */
        #emergency-controls {
            display: none; /* 默认隐藏 */
            position: absolute;
            bottom: 5px; /* 稍微离开底部边缘，避免冲突 */
            left: 50%;
            transform: translateX(-50%);
            width: 98%; /* 留一点边距，更美观 */
            max-width: 1200px; /* 在超大屏幕上限制最大宽度 */
            background-color: rgba(28, 28, 28, 0.85);
            padding: 8px;
            box-sizing: border-box;
            border-radius: 6px;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 14px;
            align-items: center;
            z-index: 99999 !important; /* 赋予最高层级，战胜一切 */
            backdrop-filter: blur(5px); /* 毛玻璃效果，更现代 */
            -webkit-backdrop-filter: blur(5px);
        }
        #emergency-progress-bar {
            flex-grow: 1;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.25);
            margin: 0 12px;
            cursor: pointer;
            border-radius: 4px;
        }
        #emergency-progress-fill {
            height: 100%;
            width: 0%;
            background-color: #00a1ff;
            border-radius: 4px;
            transition: width 0.1s linear; /* 平滑过渡 */
        }
        .time-display {
            min-width: 55px;
            text-align: center;
            font-variant-numeric: tabular-nums; /* 数字等宽，防止跳动 */
        }
    </style>
</head>
<body>
    <!-- 【关键修复】3. 将所有东西放入包装器中 -->
    <div id="player-wrapper">
        <video id="player" playsinline controls></video>
        <div id="emergency-controls">
            <div id="current-time" class="time-display">00:00</div>
            <div id="emergency-progress-bar">
                <div id="emergency-progress-fill"></div>
            </div>
            <div id="total-duration" class="time-display">00:00</div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // (JavaScript部分无需改动，和上一版完全一样)
            const video = document.getElementById('player');
            const urlParams = new URLSearchParams(window.location.search);
            const m3u8Url = urlParams.get('m3u8');
            
            function formatTime(seconds) {
                seconds = Math.round(seconds);
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = seconds % 60;
                const pad = num => ('0' + num).slice(-2);
                if (h > 0) return `${h}:${pad(m)}:${pad(s)}`;
                return `${pad(m)}:${pad(s)}`;
            }

            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(m3u8Url);
                hls.attachMedia(video);
                
                hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
                    setTimeout(() => {
                        if (video.duration === Infinity) {
                            const realDuration = data.details.totalduration;
                            if (realDuration > 0) {
                                console.log(`[Emergency Bar] Live stream detected. Activating custom controls with duration: ${realDuration}s`);
                                
                                const controls = document.getElementById('emergency-controls');
                                const progressBar = document.getElementById('emergency-progress-bar');
                                const progressFill = document.getElementById('emergency-progress-fill');
                                const currentTimeEl = document.getElementById('current-time');
                                const totalDurationEl = document.getElementById('total-duration');
                                
                                controls.style.display = 'flex';
                                totalDurationEl.textContent = formatTime(realDuration);

                                video.addEventListener('timeupdate', () => {
                                    const percentage = (video.currentTime / realDuration) * 100;
                                    progressFill.style.width = `${percentage}%`;
                                    currentTimeEl.textContent = formatTime(video.currentTime);
                                });

                                progressBar.addEventListener('click', (e) => {
                                    const rect = progressBar.getBoundingClientRect();
                                    const clickX = e.clientX - rect.left;
                                    const width = progressBar.clientWidth;
                                    const seekTime = (clickX / width) * realDuration;
                                    video.currentTime = seekTime;
                                });
                            }
                        }
                    }, 500);
                });
            }
            window.player = new Plyr(video, {});
        });
    </script>
</body>
</html>
```

### 总结

这次的更新是决定性的。通过重构HTML结构和强化CSS，我们为“应急进度条”创造了一个绝对安全、不会被干扰的显示环境。现在，无论是在小窗口还是全屏模式下，只要遇到爱奇艺的特殊视频流，这个自定义的进度条都应该会可靠地出现并正常工作。

